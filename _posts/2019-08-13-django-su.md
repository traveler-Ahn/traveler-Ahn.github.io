---
layout: post
title:  "2019/08/13 Django+Nginx+Gunicorn with AWS 설치부터배포까지~(1)"
subtitle: "2019/08/13 Django+Nginx+Gunicorn with AWS 설치부터배포까지~(1)"
categories: development
tags: django
comments: true
---

- Django 설치 및 실행, 그리고 배포에 초점을 맞춰서 글 작성합니다.
- Django + virtualenv + PostgreSQL 사용합니다.
- Django 서버 설치 및 배포 (Nginx + Gunicorn with AWS) 관련 내용

---

# Django 설치 및 배포 (1)

- [Django girls](https://tutorial.djangogirls.org/ko/) + [Udemy 강의](https://www.udemy.com/python-django-dev-to-deployment/learn/lecture/12056548?start=0#overview)를 참조하여 설치부터 배포까지 진행합니다.
- 간단한건 기록하지만 다른 곳에서 얻은 것들은 웬만하면 링크를 그대로 걸어두었습니다.
- 혹시나, 문제 생기면 언제든 답글 남겨주세요. 미리 감사합니다 :)

---

### 0. 초기 셋업

- 모든건 [여기](https://traveler-ahn.github.io/til/2019/08/13/ubuntu18-first-su/)에서 셋업한 것들을 갖췄다는 전제하에 진행합니다.

### 1. 가상환경 s/u 및 실행하기

```
### 가상환경 s/u
$ mkdir djangogirls
$ cd djangogirls
$ python3 -m venv myvenv

### 가상환경 실행
$ source myvenv/bin/activate
```

### 2. 장고 설치하기

```
### pip 최신버전 업그레이드
(myvenv) ~$ python3 -m pip install --upgrade pip

### 장고 설치
(myvenv) ~$ pip install django
```

### 3. 장고 프로젝트 만들기

```
(myvenv) ~/djangogirls$ django-admin startproject mysite .
```

- 이후의 폴더 구조

```
djangogirls
├───myenv
├───manage.py
└───mysite
        settings.py
        urls.py
        wsgi.py
        __init__.py
```

### 4. 소프트웨어 설치

#### Update packages

```
(myvenv) ~/djangogirls$ sudo apt update
(myvenv) ~/djangogirls$ sudo apt upgrade
```

#### Install Python3, PostgreSQL

```
(myvenv) ~/djangogirls$ sudo apt install python3-pip python3-dev libpq-dev postgresql postgresql-contrib
```

#### PostgreSQL DB & User setup

```
(myvenv) ~/djangogirls$ sudo -u postgres psql
```

- 이 후에는 postgreSQL shell로 진입한다.

```
## DB 생성
postgres=# CREATE DATABASE DB이름;
## User 생성
postgres=# CREATE USER 유저이름 WITH PASSWORD '비밀번호';
```

- 생성하는 DB이름과 유저이름은 Django에 database 셋팅시 사용되기 때문에 외어두고 있어야합니다.

#### Set default encoding, tansaction isolation scheme (Recommended from Django)

```
postgres=# ALTER ROLE 유저이름 SET client_encoding TO 'utf8';
postgres=# ALTER ROLE 유저이름 SET default_transaction_isolation TO 'read committed';
postgres=# ALTER ROLE 유저이름 SET timezone TO 'UTC';
```

#### Give User access to database

```
postgres=# GRANT ALL PRIVILEGES ON DATABASE DB이름 TO 유저이름;
```

#### Quit out of Postgres

```
postgres=# \q
```

---

### (Optional) PostgreSQL

#### [생성한 유저 확인]

```
postgres=# \du

or 

postgres=# \du+ (Description 컬럼이 추가됨)
```

#### [생성한 유저 삭제]

```
postgres=# DROP ROLE 유저이름;
```

#### [생성한 데이터베이스 목록 조회]

```
postgres=# \list (또는 \l)

or 

postgres=# \list+ (Size, Tablespace, Description 컬럼이 추가됨)
```

---

### 5. setting.py 설정변경

```
# 정적파일 경로 추가 (STATIC_ROOT경로 추가)
# Production serving시 ROOT폴더에 STATIC 파일들을 모아야한다.

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
```

```
# HOST IP 주소 추가
# 호스팅 할 IP 주소를 추가해준다.

ALLOWED_HOSTS = ['127.0.0.1']
```

```
# 데이터 베이스 변경
# 기존의 디폴트로 된 sqlite에서 postgresql로 DATABASE를 변경해준다.

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'DB이름',
        'USER': '유저이름',
        'PASSWORD': '비밀번호',
        'HOST': '127.0.0.1'
    }
}
```

### 6. FIRST data migration

- 데이터 베이스와 연동작업 및 첫 정보를 기입(유저테이블+기타등등 정보가 디폴트로 담긴다.)하기 위해 migration을 한다.

```
## 먼저 python과 postgreSQL을 연결해주는 커넥터인 psycopg2를 설치한다.

(myvenv) ~/djangogirls$ pip install psycopg2

## Database migration
(myvenv) ~/djangogirls$ python manage.py migrate
```

- 정상 작동 시 하기와 같은 메시지가 나온다.

```
## Operations to perform을 보면 다양한 디폴트 정보가 처음에 DB에 담기게 됨을 확인 할 수 있다.

Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
```

### 7. Run Server!

```
(myvenv) ~/djangogirls$ python manage.py runserver
```

- 이후에 `127.0.0.1:8000`정보로 접속을 하면 Congratulations 화면을 확인 할 수 있다.

---

#### So far,

- **Local 환경에서!**  `중요!!!`

- virtualenv 가상환경에서 Dajngo를 설치하고,
- Django project를 만들고, 
- PostgreSQL DB를 만들어서 
- Django project와 연결시키고,
- Django server를 구동시켜보았다.

##### 여기서는 Django project를 어떻게 잘 만드는 것이냐가 아닌, 어떻게 Deploy하냐를 중점적으로 다룰 것이기에 초기 셋업은 여기까지만 진행할 것이다.

Django 프로젝트를 [여기](https://tutorial.djangogirls.org/ko/django_start_project/)를 참조하여 더욱 발전시킨 이후 후속과정을 진행하면 된다.

---

### From now,

- **AWS 환경에서!**
- Local machine과 ssh 연결하여,
- Local에서 만든 Django 프로젝트를 github에 올리고, 이를 AWS에서 Clonning하고,
  - 혹시나 귀찮은 분들을 위해서... 제 [깃헙의 자료](https://github.com/traveler-Ahn/django-test)를 Cloning 하시면 됩니다...
- AWS에서 Django 서버 환경 셋팅하고,
- Gunicorn 셋업하고,
- Nginx 셋업하는 걸로 배포까지 하겠습니다.

---

> 혹시 여기서 더 하고싶은 분들은 Domain까지 연결하시면 되는데  저는 Nginx 셋업 및 배포까지만...

---
